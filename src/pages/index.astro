---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { sortAnalysesByDate } from '../utils/sort';
import { portfolio, watchlist, updates } from '../data/portfolio';

const analyses = sortAnalysesByDate(await getCollection('analyses'));
const latestAnalysis = analyses[0];

// Trier le portefeuille par poids décroissant
const sortedPortfolio = [...portfolio].sort((a, b) => b.weight - a.weight);
---

<BaseLayout title="Totem Analyse - Lettre d'Investissement">
  <div class="container mx-auto px-6 py-12 max-w-3xl">
    <!-- Logo and Header -->
    <header class="text-center mb-12 pt-8">
      <img src="/images/logo_totem_analyse.png" alt="Totem Analyse Logo" class="w-40 mx-auto mb-8">
      <h1 class="text-4xl font-bold text-totem-green mb-3 tracking-tight">Totem Analyse</h1>
      <p class="text-gray-600 text-lg">Lettre d'Investissement indépendante</p>
      <div class="w-24 h-0.5 bg-totem-green mx-auto mt-6"></div>
    </header>

    <!-- Main CTA -->
    <div class="mb-6">
      <a href="/analyses"
         class="block w-full py-4 px-6 bg-totem-green text-white
                text-center font-semibold text-lg hover:bg-totem-light transition-colors
                duration-200 border border-totem-green">
        Toutes les Analyses
      </a>
    </div>

    <!-- Ticker Banner -->
    <div class="mb-10 border border-gray-200 bg-white overflow-hidden">
      <div class="flex items-center">
        <span class="bg-totem-green text-white text-xs font-semibold px-3 py-2 uppercase tracking-wide shrink-0">
          Analyses
        </span>
        <div class="ticker-wrapper overflow-hidden flex-1">
          <div class="ticker-content flex items-center gap-8 py-2 px-4">
            {analyses.map((analysis) => (
              <a href={`/analyses/${analysis.slug}`} class="ticker-item flex items-center gap-2 text-sm whitespace-nowrap hover:text-totem-green transition-colors">
                <span class="font-semibold text-totem-green">{analysis.data.ticker}</span>
                <span class="text-gray-600">{analysis.data.title.replace('Apparté sur ', '')}</span>
                <span class="text-gray-400">•</span>
              </a>
            ))}
            {analyses.map((analysis) => (
              <a href={`/analyses/${analysis.slug}`} class="ticker-item flex items-center gap-2 text-sm whitespace-nowrap hover:text-totem-green transition-colors">
                <span class="font-semibold text-totem-green">{analysis.data.ticker}</span>
                <span class="text-gray-600">{analysis.data.title.replace('Apparté sur ', '')}</span>
                <span class="text-gray-400">•</span>
              </a>
            ))}
          </div>
        </div>
      </div>
    </div>

    <!-- Latest Analysis -->
    {latestAnalysis && (
      <div class="mb-10">
        <p class="text-xs text-gray-500 uppercase tracking-wide mb-3">Dernière analyse</p>
        <a href={`/analyses/${latestAnalysis.slug}`} class="group block bg-white border border-gray-200 hover:border-totem-green transition-colors">
          <div class="p-5">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-2xl">{latestAnalysis.data.emoji}</span>
              <span class="px-2 py-0.5 bg-totem-green text-white text-xs font-medium">{latestAnalysis.data.ticker}</span>
            </div>
            <h2 class="text-xl font-bold text-gray-900 group-hover:text-totem-green transition-colors mb-2">
              {latestAnalysis.data.title.replace('Apparté sur ', '')}
            </h2>
            <p class="text-gray-600 text-sm mb-3">{latestAnalysis.data.description}</p>
            <p class="text-xs text-gray-500">{latestAnalysis.data.publishDate} · {latestAnalysis.data.readTime}</p>
          </div>
        </a>
      </div>
    )}

    <!-- Portfolio Section -->
    <div class="mb-10">
      <p class="text-xs text-gray-500 uppercase tracking-wide mb-3">Notre Portefeuille</p>
      <div class="bg-white border border-gray-200">
        <!-- Header -->
        <div class="flex items-center justify-between px-5 py-3 border-b border-gray-100 bg-gray-50">
          <span class="text-xs text-gray-500 uppercase tracking-wide font-medium">Position</span>
          <span class="text-xs text-gray-500 uppercase tracking-wide font-medium">Poids</span>
        </div>

        {sortedPortfolio.map((position, index) => {
          const isLast = index === sortedPortfolio.length - 1;
          const hasAnalysis = !!position.analysisSlug;
          const Tag = hasAnalysis ? 'a' : 'div';

          return (
            <Tag
              href={hasAnalysis ? `/analyses/${position.analysisSlug}` : undefined}
              class={`portfolio-item group block ${!isLast ? 'border-b border-gray-100' : ''} ${hasAnalysis ? 'hover:bg-gray-50 transition-colors cursor-pointer' : ''}`}
            >
              <div class="px-5 py-4">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-4">
                    <span class="rank-number text-2xl font-bold text-totem-green">{index + 1}</span>
                    <div>
                      <div class="flex items-center gap-2 mb-1">
                        <span class={`font-semibold text-gray-900 ${hasAnalysis ? 'group-hover:text-totem-green transition-colors' : ''}`}>{position.name}</span>
                        <span class={`px-2 py-0.5 text-xs font-medium ${hasAnalysis ? 'bg-totem-green text-white' : 'bg-gray-100 text-gray-600'}`}>{position.ticker}</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">{position.flag} {position.exchange}</span>
                        <span class="text-xs text-gray-400">•</span>
                        {hasAnalysis ? (
                          <span class="text-xs text-totem-green font-medium">Voir l'analyse →</span>
                        ) : (
                          <span class="text-xs text-amber-600">Analyse à venir</span>
                        )}
                      </div>
                    </div>
                  </div>
                  <div class="weight-bar w-24">
                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                      <div class="h-full bg-totem-green rounded-full" style={`width: ${position.weight}%`}></div>
                    </div>
                  </div>
                </div>
                <p class="text-xs text-gray-500 italic pl-12 border-l-2 border-gray-100 ml-3">{position.thesis}</p>
              </div>
            </Tag>
          );
        })}
      </div>
      <p class="text-xs text-gray-400 mt-2 text-center italic">Classé par taille de position</p>
    </div>

    <!-- Watchlist Section -->
    <div class="mb-10">
      <p class="text-xs text-gray-500 uppercase tracking-wide mb-3">Watchlist</p>
      <div class="bg-white border border-gray-200">
        <div class="grid divide-y divide-gray-100">
          {watchlist.map((item) => (
            <div class="px-5 py-3 hover:bg-gray-50 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <span class="text-lg">{item.flag}</span>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-gray-900 text-sm">{item.name}</span>
                      <span class="px-1.5 py-0.5 bg-gray-100 text-gray-500 text-xs">{item.ticker}</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-0.5">{item.note}</p>
                  </div>
                </div>
                <span class="text-xs text-gray-400">{item.exchange}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
      <p class="text-xs text-gray-400 mt-2 text-center italic">Entreprises suivies, pas encore en portefeuille</p>
    </div>

    <!-- Updates Feed -->
    <div class="mb-10">
      <p class="text-xs text-gray-500 uppercase tracking-wide mb-3">Dernières Mises à Jour</p>
      <div class="bg-white border border-gray-200">
        <div class="divide-y divide-gray-100">
          {updates.slice(0, 5).map((update) => (
            <div class="px-5 py-3 flex items-start gap-3">
              <span class={`shrink-0 w-2 h-2 rounded-full mt-1.5 ${
                update.type === 'new' ? 'bg-green-500' :
                update.type === 'sold' ? 'bg-red-500' :
                update.type === 'watch' ? 'bg-blue-500' :
                'bg-amber-500'
              }`}></span>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  <span class="font-medium text-gray-900 text-sm">{update.text}</span>
                </div>
                <div class="flex items-center gap-2 mt-0.5">
                  <span class="text-xs text-gray-400">{update.date}</span>
                  <span class="px-1.5 py-0.5 bg-gray-100 text-gray-500 text-xs">{update.ticker}</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>

    <!-- Newsletter Signup -->
    <div class="mb-10">
      <div class="bg-gradient-to-br from-totem-green to-totem-light p-6 text-white text-center">
        <h3 class="text-lg font-bold mb-2">Recevez nos analyses</h3>
        <p class="text-sm opacity-90 mb-4">Une analyse approfondie par mois, directement dans votre boîte mail.</p>
        <iframe
          src="https://totemanalyse.substack.com/embed"
          width="100%"
          height="80"
          style="background: transparent;"
          frameborder="0"
          scrolling="no"
        ></iframe>
      </div>
    </div>

    <!-- Social Links -->
    <div class="grid grid-cols-2 gap-4 mb-16">
      <a href="https://twitter.com/TotemAnalyse" target="_blank" rel="noopener noreferrer"
         class="block py-3 px-4 bg-white border border-gray-300 text-gray-700
                text-center font-medium hover:border-totem-green hover:text-totem-green
                transition-colors duration-200 text-sm">
        Twitter / X
      </a>

      <a href="https://totemanalyse.substack.com" target="_blank" rel="noopener noreferrer"
         class="block py-3 px-4 bg-white border border-gray-300 text-gray-700
                text-center font-medium hover:border-totem-green hover:text-totem-green
                transition-colors duration-200 text-sm">
        Substack
      </a>
    </div>

    <!-- Footer -->
    <footer class="text-center text-gray-500 text-sm border-t border-gray-200 pt-8">
      <p>© 2025 Totem Analyse</p>
      <p class="mt-2 text-xs">Ceci n'est pas un conseil en investissement.</p>
    </footer>
  </div>
</BaseLayout>

<style>
  .ticker-wrapper {
    mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
    -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
  }

  .ticker-content {
    animation: ticker 20s linear infinite;
  }

  .ticker-content:hover {
    animation-play-state: paused;
  }

  @keyframes ticker {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }
</style>
