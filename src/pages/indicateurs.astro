---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ChartCard from '../components/ChartCard.astro';
import EnergyMixChart from '../components/EnergyMixChart';
import OilConsumptionByRegionChart from '../components/OilConsumptionByRegionChart';
---

<BaseLayout title="Indicateurs clé de l'économie - Totem Analyse" description="Suivez l'évolution des principaux indicateurs économiques et financiers : indices boursiers (S&P 500, CAC 40), matières premières (Or, Pétrole), devises (EUR/USD), taux et crypto. Données sur 20 ans.">
  <div class="container mx-auto px-6 py-8 max-w-6xl">
    <Header currentPage="indicateurs" />

    <main>
      <!-- Header -->
      <div class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Indicateurs Clé de l'Économie</h1>
        <p class="text-gray-600">Évolution sur 20 ans des principaux indicateurs économiques et financiers</p>
        <p class="text-xs text-gray-400 mt-2" id="last-updated"></p>
      </div>

      <!-- Tabs de navigation principale -->
      <div class="flex border-b border-gray-200 mb-6" id="main-tabs">
        <button
          data-tab="marches"
          class="px-6 py-3 text-sm font-medium border-b-2 border-totem-green text-totem-green transition-colors"
        >
          Marchés
        </button>
        <button
          data-tab="energie"
          class="px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors"
        >
          Énergie
        </button>
      </div>

      <!-- Contrôles globaux de timeline -->
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-8">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
          <span class="text-sm font-medium text-gray-700">Période d'affichage pour tous les graphiques :</span>
          <div class="flex gap-2" id="global-time-controls">
            <button
              data-range="1y"
              class="px-4 py-2 text-sm rounded transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200"
            >
              1 an
            </button>
            <button
              data-range="5y"
              class="px-4 py-2 text-sm rounded transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200"
            >
              5 ans
            </button>
            <button
              data-range="10y"
              class="px-4 py-2 text-sm rounded transition-colors bg-totem-green text-white"
            >
              10 ans
            </button>
            <button
              data-range="20y"
              class="px-4 py-2 text-sm rounded transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200"
            >
              20 ans
            </button>
          </div>
        </div>
      </div>

      <!-- ========== TAB MARCHÉS ========== -->
      <div id="tab-marches">
        <!-- Navigation rapide pour Marchés -->
        <div class="border-t border-b border-gray-200 py-3 mb-8 overflow-x-auto" id="quick-nav-marches">
          <div class="flex items-center gap-2 min-w-max">
            <span class="text-xs text-gray-400 uppercase tracking-wide shrink-0">Aller à</span>
            <span class="text-gray-300 shrink-0">—</span>
            <a href="#sp500" class="text-sm text-gray-600 hover:text-totem-green transition-colors">S&P 500</a>
            <span class="text-gray-300">·</span>
            <a href="#nasdaq" class="text-sm text-gray-600 hover:text-totem-green transition-colors">NASDAQ</a>
            <span class="text-gray-300">·</span>
            <a href="#cac40" class="text-sm text-gray-600 hover:text-totem-green transition-colors">CAC 40</a>
            <span class="text-gray-300">·</span>
            <a href="#dax" class="text-sm text-gray-600 hover:text-totem-green transition-colors">DAX</a>
            <span class="text-gray-300">·</span>
            <a href="#nikkei" class="text-sm text-gray-600 hover:text-totem-green transition-colors">Nikkei</a>
            <span class="text-gray-300">·</span>
            <a href="#gold" class="text-sm text-gray-600 hover:text-totem-green transition-colors">Or</a>
            <span class="text-gray-300">·</span>
            <a href="#silver" class="text-sm text-gray-600 hover:text-totem-green transition-colors">Argent</a>
            <span class="text-gray-300">·</span>
            <a href="#brent" class="text-sm text-gray-600 hover:text-totem-green transition-colors">Pétrole</a>
            <span class="text-gray-300">·</span>
            <a href="#natgas" class="text-sm text-gray-600 hover:text-totem-green transition-colors">Gaz</a>
            <span class="text-gray-300">·</span>
            <a href="#eurusd" class="text-sm text-gray-600 hover:text-totem-green transition-colors">EUR/USD</a>
            <span class="text-gray-300">·</span>
            <a href="#bitcoin" class="text-sm text-gray-600 hover:text-totem-green transition-colors">Bitcoin</a>
            <span class="text-gray-300">·</span>
            <a href="#fr10y" class="text-sm text-gray-600 hover:text-totem-green transition-colors">US 10Y</a>
          </div>
        </div>

        <!-- Sections des marchés -->
          <!-- Indices Boursiers -->
          <section class="mb-10">
            <div class="flex items-center gap-3 mb-4">
              <h2 class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Indices Boursiers</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <ChartCard id="sp500" indicatorKey="sp500" color="#006B4F" name="S&P 500" />
              <ChartCard id="nasdaq" indicatorKey="nasdaq" color="#00d4aa" name="NASDAQ" />
              <ChartCard id="cac40" indicatorKey="cac40" color="#1e40af" name="CAC 40" />
              <ChartCard id="dax" indicatorKey="dax" color="#dc2626" name="DAX" />
              <ChartCard id="nikkei" indicatorKey="nikkei" color="#ec4899" name="Nikkei 225" />
            </div>
          </section>

          <!-- Matières Premières -->
          <section class="mb-10">
            <div class="flex items-center gap-3 mb-4">
              <h2 class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Matières Premières</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <ChartCard id="gold" indicatorKey="gold" color="#ca8a04" name="l'Or" />
              <ChartCard id="silver" indicatorKey="silver" color="#94a3b8" name="l'Argent" />
              <ChartCard id="brent" indicatorKey="brent" color="#0f172a" name="le Brent" />
              <ChartCard id="natgas" indicatorKey="natgas" color="#0ea5e9" name="le Gaz Naturel" />
            </div>
          </section>

          <!-- Devises, Crypto & Taux -->
          <section class="mb-10">
            <div class="flex items-center gap-3 mb-4">
              <h2 class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Devises, Crypto & Taux</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <ChartCard id="eurusd" indicatorKey="eurusd" color="#2563eb" name="EUR/USD" />
              <ChartCard id="bitcoin" indicatorKey="bitcoin" color="#f7931a" name="le Bitcoin" />
              <ChartCard id="fr10y" indicatorKey="fr10y" color="#dc2626" name="le Taux US 10 ans" />
            </div>
          </section>
      </div>

      <!-- ========== TAB ÉNERGIE ========== -->
      <div id="tab-energie" class="hidden">
        <!-- Énergie - Consommation par région -->
        <section class="mb-10">
          <div class="flex items-center gap-3 mb-4">
            <h2 class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Consommation de Pétrole</h2>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <ChartCard indicatorKey="oil_consumption_world" color="#1e3a5f" name="la Conso. Pétrole Monde" />
            <ChartCard indicatorKey="oil_consumption_usa" color="#3b82f6" name="la Conso. Pétrole USA" />
            <ChartCard indicatorKey="oil_consumption_china" color="#ef4444" name="la Conso. Pétrole Chine" />
            <ChartCard indicatorKey="oil_consumption_europe" color="#f59e0b" name="la Conso. Pétrole Europe" />
            <ChartCard indicatorKey="oil_consumption_oecd" color="#8b5cf6" name="la Conso. Pétrole OCDE" />
          </div>
        </section>

        <!-- Énergie - Mix énergétique mondial -->
        <section class="mb-10">
          <div class="flex items-center gap-3 mb-4">
            <h2 class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Mix Énergétique Mondial</h2>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <ChartCard indicatorKey="energy_petroleum" color="#0f172a" name="la Conso. Mondiale Pétrole" />
            <ChartCard indicatorKey="energy_natgas" color="#0ea5e9" name="la Conso. Mondiale Gaz" />
            <ChartCard indicatorKey="energy_coal" color="#374151" name="la Conso. Mondiale Charbon" />
            <ChartCard indicatorKey="energy_nuclear" color="#eab308" name="la Conso. Mondiale Nucléaire" />
            <ChartCard indicatorKey="energy_renewables" color="#22c55e" name="la Conso. Mondiale Renouvelables" />
          </div>
        </section>

        <!-- Graphiques de synthèse -->
        <section class="mb-10">
          <div class="flex items-center gap-3 mb-4">
            <h2 class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Graphiques de Synthèse</h2>
          </div>
          <div class="grid grid-cols-1 gap-6">
            <EnergyMixChart client:load />
            <OilConsumptionByRegionChart client:load />
          </div>
        </section>
      </div>

      <!-- Note sur les données -->
      <section class="mb-10">
        <div class="bg-gray-50 border border-gray-200 p-6">
          <h3 class="font-semibold text-gray-900 mb-2">Sources des données</h3>
          <p class="text-sm text-gray-600 mb-3">
            Les données sont mises à jour automatiquement via GitHub Actions. Sources utilisées :
          </p>
          <ul class="text-sm text-gray-600 list-disc pl-5 space-y-1">
            <li><strong>Indices boursiers</strong> — Yahoo Finance (S&P 500, NASDAQ, CAC 40, DAX, Nikkei 225)</li>
            <li><strong>Matières premières</strong> — Yahoo Finance (Or, Argent, Pétrole Brent, Gaz Naturel)</li>
            <li><strong>Devises, Crypto & Taux</strong> — Yahoo Finance (EUR/USD, Bitcoin, Taux US 10 ans)</li>
            <li><strong>Énergie</strong> — EIA (Energy Information Administration)</li>
          </ul>
        </div>
      </section>

      <!-- Back link -->
      <div class="text-center">
        <a href="/" class="text-totem-green hover:text-totem-light text-sm font-medium">
          ← Retour à l'accueil
        </a>
      </div>
    </main>

    <Footer />
  </div>
</BaseLayout>

<script>
  // Gestion des tabs
  function switchTab(tabName) {
    const tabMarches = document.getElementById('tab-marches');
    const tabEnergie = document.getElementById('tab-energie');
    const tabButtons = document.querySelectorAll('#main-tabs button');

    // Mettre à jour les boutons de tabs
    tabButtons.forEach(btn => {
      const btnTab = btn.getAttribute('data-tab');
      if (btnTab === tabName) {
        btn.className = 'px-6 py-3 text-sm font-medium border-b-2 border-totem-green text-totem-green transition-colors';
      } else {
        btn.className = 'px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors';
      }
    });

    // Afficher/masquer les contenus
    if (tabName === 'marches') {
      tabMarches.classList.remove('hidden');
      tabEnergie.classList.add('hidden');
    } else {
      tabMarches.classList.add('hidden');
      tabEnergie.classList.remove('hidden');
    }
  }

  // Afficher la date de dernière mise à jour
  fetch('/data/indicators.json')
    .then(res => res.json())
    .then(data => {
      const el = document.getElementById('last-updated');
      if (el && data.lastUpdated) {
        const date = new Date(data.lastUpdated);
        el.textContent = `Données mises à jour le ${date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}`;
      }
    });

  // Gérer les tabs
  const mainTabs = document.getElementById('main-tabs');
  if (mainTabs) {
    mainTabs.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-tab');
        switchTab(tab);
      });
    });
  }

  // Gérer les contrôles globaux de timeline
  const globalControls = document.getElementById('global-time-controls');
  if (globalControls) {
    const buttons = globalControls.querySelectorAll('button');

    buttons.forEach(button => {
      button.addEventListener('click', () => {
        const range = button.getAttribute('data-range');

        // Mettre à jour l'apparence des boutons
        buttons.forEach(btn => {
          if (btn === button) {
            btn.className = 'px-4 py-2 text-sm rounded transition-colors bg-totem-green text-white';
          } else {
            btn.className = 'px-4 py-2 text-sm rounded transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200';
          }
        });

        // Émettre un événement personnalisé pour informer les composants
        const event = new CustomEvent('globalTimeRangeChange', { detail: { range } });
        window.dispatchEvent(event);
      });
    });
  }
</script>
